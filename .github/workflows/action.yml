name: ğŸš€ CI
on:
  push:
    tags:
      - "**"
env:
  PROPERTIES_PATH: "./android/key.properties"
  KEY_JKS: ${{ secrets.KEY_JKS }}
  ALIAS_PASSWORD: ${{ secrets.ALIAS_PASSWORD }}
  KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: â˜• Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"
      - name: ğŸ¦ Set up Flutter
        uses: subosito/flutter-action@v1
        with:
          channel: "stable"
      - name: ğŸ“‘ Create key.properties
        run: |
          echo keyPassword=\${{ secrets.KEY_PASSWORD }} > ${{env.PROPERTIES_PATH}}
          echo storePassword=\${{ secrets.ALIAS_PASSWORD }} >> ${{env.PROPERTIES_PATH}}
          echo keyAlias=\upload >> ${{env.PROPERTIES_PATH}}
      - name: ğŸ§¹ Flutter Clean
        run: flutter clean
      - name: ğŸ“¦ Get Flutter Packages
        run: flutter pub get
      - name: ğŸ—ï¸ Build Gradle
        run: base64 -d <<< $KEY_JKS > ./android/app/release-key.jks
      - name: ğŸ•’ Set Build Number
        run: echo "BUILD_NUMBER=$(( $(date +%s) % 2000000000 ))" >> $GITHUB_ENV
      - name: ğŸ”§ Build APK
        run: flutter build apk --target lib/main_staging.dart --flavor staging --release --obfuscate --split-debug-info=build/app/outputs/symbols --build-number=${{ env.BUILD_NUMBER }}
      - name: ğŸ“‚ List APK files
        run: ls build/app/outputs/flutter-apk
      - name: ğŸš€ Upload to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          token: ${{ secrets.FIREBASE_TOKEN }}
          serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
          groups: internal-testers
          file: build/app/outputs/flutter-apk/app-staging-release.apk
